<script>
    function generatePDF() {
        const cont = document.getElementById('pdf-container');
        cont.innerHTML = ""; 
        cont.style.display = "block";
        const mName = document.getElementById('monthSelect').selectedOptions[0].text;

        // استدعاء كافة المزارع المسجلة
        Object.keys(db.farms).forEach(f => {
            // تحميل بيانات المزرعة الحالية لبناء جدولها
            document.getElementById('farmSelect').value = f;
            loadFarmData(); 

            const tableClone = document.getElementById('attendanceTable').cloneNode(true);
            
            // تنظيف الجدول من خانات الإدخال لتحويلها لنصوص ثابتة في الـ PDF
            tableClone.querySelectorAll('input').forEach(i => {
                i.parentElement.innerText = i.value;
            });

            // إضافة الصفحة للمحتوى مع تنسيق يضمن العرض الكامل
            cont.innerHTML += `
                <div class="pdf-page" style="width: 100%; overflow: hidden;">
                    <h3 style="text-align:center; margin-bottom: 5px;">كشف حضور وحسابات: ${f}</h3>
                    <p style="text-align:center; font-size: 12px; margin-bottom: 10px;">شهر: ${mName} 2026</p>
                    <table style="width: 100%; table-layout: fixed; border-collapse: collapse; font-size: 8px;">
                        ${tableClone.innerHTML}
                    </table>
                </div>`;
        });

        // إعدادات تصدير الـ PDF لضمان احتواء كافة الأعمدة (31 يوم)
        const opt = {
            margin: [5, 2, 5, 2], // تقليل الهوامش الجانبية جداً
            filename: `تقارير_عالم_الزيتون_${mName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // وضع العرض
        };

        // تنفيذ التصدير
        html2pdf().set(opt).from(cont).save().then(() => {
            cont.style.display = "none";
            loadFarmData(); // العودة لعرض المزرعة الأصلية في التطبيق
        });
    }
</script>
